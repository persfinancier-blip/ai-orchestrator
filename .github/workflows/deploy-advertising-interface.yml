name: Deploy Advertising (UI + API)

on:
  push:
    branches: ["main"]
    paths:
      - "core/orchestrator/modules/advertising/interface/**"
      - ".github/workflows/deploy-advertising-interface.yml"

concurrency:
  group: deploy-advertising-ui-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: core/orchestrator/modules/advertising/interface/package-lock.json

      - name: Install & build UI
        working-directory: core/orchestrator/modules/advertising/interface
        run: |
          npm ci
          npm run build

      # UI deploy — как в работающем
      - name: Rsync dist to server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete
          path: core/orchestrator/modules/advertising/interface/dist/
          remote_path: ${{ secrets.DEPLOY_PATH }}/
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_port: ${{ secrets.DEPLOY_PORT }}
          remote_key: ${{ secrets.DEPLOY_SSH_KEY }}

      # API deploy — тоже как в работающем (appleboy ssh-action)
      - name: Update API repo + restart PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail

            REPO_DIR="/srv/ai-src/ai-orchestrator"
            APP_DIR="$REPO_DIR/core/orchestrator/modules/advertising/interface"

            # ВАЖНО: один владелец репы = тот, под кем зашли (DEPLOY_USER)
            # Это убирает "dubious ownership" без safe.directory.
            if [ -d "$REPO_DIR" ]; then
              sudo chown -R "$USER":"$USER" "$REPO_DIR"
            fi

            if [ ! -d "$REPO_DIR/.git" ]; then
              mkdir -p "$(dirname "$REPO_DIR")"
              git clone "${{ secrets.REPO_SSH_URL }}" "$REPO_DIR"
              sudo chown -R "$USER":"$USER" "$REPO_DIR"
            fi

            cd "$REPO_DIR"
            git fetch --all
            git reset --hard origin/main

            cd "$APP_DIR"
            npm ci

            sudo env \
              PGHOST="${{ secrets.PGHOST }}" \
              PGPORT="${{ secrets.PGPORT }}" \
              PGUSER="${{ secrets.PGUSER }}" \
              PGPASSWORD="${{ secrets.PGPASSWORD }}" \
              PGDATABASE="${{ secrets.PGDATABASE }}" \
              SPACE_API_PORT="${{ secrets.AIR_PORT }}" \
              pm2 startOrReload ecosystem.config.cjs --update-env

            sudo pm2 save --force

            curl -fsS "http://127.0.0.1:${{ secrets.AIR_PORT }}${{ secrets.API_BASE }}/health" >/dev/null
            echo "OK: health"

      - name: Reload Apache
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            sudo systemctl reload apache2
