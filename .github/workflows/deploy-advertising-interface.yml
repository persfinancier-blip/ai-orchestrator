name: Deploy Advertising (UI + API)

on:
  push:
    branches: ["main"]
    paths:
      - "core/orchestrator/modules/advertising/interface/**"
      - ".github/workflows/deploy-advertising-interface.yml"

concurrency:
  group: deploy-advertising-ui-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: core/orchestrator/modules/advertising/interface/package-lock.json

      # ---------------- UI BUILD ----------------
      - name: Install UI deps
        working-directory: core/orchestrator/modules/advertising/interface
        run: npm ci

      - name: Build UI
        working-directory: core/orchestrator/modules/advertising/interface
        run: npm run build

      # ---------------- SSH SETUP ----------------
      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.DEPLOY_PORT }}" "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      # ---------------- DEPLOY UI DIST ----------------
      - name: Deploy UI dist (rsync)
        shell: bash
        run: |
          set -euo pipefail
          rsync -az --delete -e "ssh -p ${{ secrets.DEPLOY_PORT }} -i ~/.ssh/id_rsa" \
            core/orchestrator/modules/advertising/interface/dist/ \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.WEB_ROOT }}/core/orchestrator/modules/advertising/interface/dist/"

      # ---------------- DEPLOY API (SERVER) ----------------
      - name: Deploy API code + restart PM2
        shell: bash
        run: |
          set -euo pipefail

          ssh -p "${{ secrets.DEPLOY_PORT }}" -i ~/.ssh/id_rsa "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
          "bash -lc '
            set -euo pipefail

            REPO_DIR=/srv/ai-src/ai-orchestrator
            APP_DIR=\$REPO_DIR/core/orchestrator/modules/advertising/interface
            API_NAME=ai-orchestrator-adv-api

            if [ ! -d \"\$REPO_DIR/.git\" ]; then
              mkdir -p \"\$(dirname \"\$REPO_DIR\")\"
              git clone \"${{ secrets.REPO_SSH_URL }}\" \"\$REPO_DIR\"
            fi

            cd \"\$REPO_DIR\"
            git fetch --all
            git reset --hard origin/main

            cd \"\$APP_DIR\"
            npm ci

            sudo env \
              PGHOST=\"${{ secrets.PGHOST }}\" \
              PGPORT=\"${{ secrets.PGPORT }}\" \
              PGUSER=\"${{ secrets.PGUSER }}\" \
              PGPASSWORD=\"${{ secrets.PGPASSWORD }}\" \
              PGDATABASE=\"${{ secrets.PGDATABASE }}\" \
              SPACE_API_PORT=\"${{ secrets.AIR_PORT }}\" \
              pm2 startOrReload ecosystem.config.cjs --update-env

            sudo pm2 save --force

            curl -fsS \"http://127.0.0.1:${{ secrets.AIR_PORT }}${{ secrets.API_BASE }}/health\" >/dev/null
            echo OK: health

            STATUS=\$(curl -s -o /dev/null -w \"%{http_code}\" \"http://127.0.0.1:${{ secrets.AIR_PORT }}${{ secrets.API_BASE }}/tables\" || true)
            echo Local tables status: \$STATUS
          '"
