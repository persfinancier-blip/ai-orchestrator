name: Deploy Advertising (UI + API)

on:
  push:
    branches: ["main"]
    paths:
      - "core/orchestrator/modules/advertising/interface/**"
      - ".github/workflows/deploy-advertising-interface.yml"

concurrency:
  group: deploy-advertising-ui-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: core/orchestrator/modules/advertising/interface/package-lock.json

      # ---------------- UI BUILD ----------------
      - name: Install UI deps
        working-directory: core/orchestrator/modules/advertising/interface
        run: npm ci

      - name: Build UI
        working-directory: core/orchestrator/modules/advertising/interface
        run: npm run build

      # ---------------- SSH SETUP ----------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.DEPLOY_PORT }}" "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      # ---------------- DEPLOY UI DIST ----------------
      - name: Deploy UI dist (rsync)
        run: |
          rsync -az --delete \
            core/orchestrator/modules/advertising/interface/dist/ \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.WEB_ROOT }}/core/orchestrator/modules/advertising/interface/dist/"

      # ---------------- DEPLOY API (SERVER) ----------------
      - name: Deploy API code + restart PM2
        env:
          REPO_SSH_URL: ${{ secrets.REPO_SSH_URL }}

          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}

          API_HOST: ${{ secrets.API_HOST }}
          API_PORT: ${{ secrets.API_PORT }}
          API_BASE: ${{ secrets.API_BASE }}
        run: |
          ssh -p "${{ secrets.DEPLOY_PORT }}" "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" << SSH
            set -euo pipefail

            REPO_DIR="/srv/ai-src/ai-orchestrator"
            APP_DIR="\$REPO_DIR/core/orchestrator/modules/advertising/interface"

            # 1) Ensure repo exists
            if [ ! -d "\$REPO_DIR/.git" ]; then
              mkdir -p "\$(dirname "\$REPO_DIR")"
              git clone "${REPO_SSH_URL}" "\$REPO_DIR"
            fi

            # 2) Update code
            cd "\$REPO_DIR"
            git fetch --all
            git reset --hard origin/main

            # 3) Install deps (same folder contains server/*)
            cd "\$APP_DIR"
            npm ci

            # 4) Ensure pm2 installed
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm i -g pm2
            fi

            # 5) Export env from GitHub Secrets (no hardcoded addresses)
            export PGHOST="${PGHOST}"
            export PGPORT="${PGPORT}"
            export PGUSER="${PGUSER}"
            export PGPASSWORD="${PGPASSWORD}"
            export PGDATABASE="${PGDATABASE}"

            export SPACE_API_PORT="${API_PORT}"

            export API_HOST="${API_HOST}"
            export API_PORT="${API_PORT}"
            export API_BASE="${API_BASE}"

            # 6) Start/reload API via PM2
            pm2 startOrReload ecosystem.config.cjs --update-env
            pm2 save

            # 7) Local health checks (no hardcoded host/port/path)
            API_URL="http://\${API_HOST}:\${API_PORT}\${API_BASE}"

            curl -fsS "\${API_URL}/space" >/dev/null
            echo "OK: \${API_BASE}/space"

            STATUS=\$(curl -s -o /dev/null -w "%{http_code}" "\${API_URL}/tables" || true)
            echo "Local \${API_BASE}/tables status: \${STATUS}"
SSH

      # ---------------- PUBLIC CHECK (optional) ----------------
      - name: Public health check (optional)
        if: ${{ secrets.PUBLIC_BASE_URL != '' }}
        continue-on-error: true
        env:
          PUBLIC_BASE_URL: ${{ secrets.PUBLIC_BASE_URL }}
          API_BASE: ${{ secrets.API_BASE }}
        run: |
          curl -i "${PUBLIC_BASE_URL}${API_BASE}/space" || true
          curl -i "${PUBLIC_BASE_URL}${API_BASE}/tables" || true
