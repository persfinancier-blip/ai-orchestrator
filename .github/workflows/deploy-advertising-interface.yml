name: Deploy Advertising (UI + API)

on:
  push:
    branches: ["main"]
    paths:
      - "core/orchestrator/modules/advertising/interface/**"
      - ".github/workflows/deploy-advertising-interface.yml"

concurrency:
  group: deploy-advertising-ui-api
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: core/orchestrator/modules/advertising/interface/package-lock.json

      - name: Install & build UI
        working-directory: core/orchestrator/modules/advertising/interface
        run: |
          npm ci
          npm run build

      # UI dist
      - name: Rsync UI dist to server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete
          path: core/orchestrator/modules/advertising/interface/dist/
          remote_path: ${{ secrets.DEPLOY_PATH }}/
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_port: ${{ secrets.DEPLOY_PORT }}
          remote_key: ${{ secrets.DEPLOY_SSH_KEY }}

      # API runtime (без git на сервере)
      - name: Rsync API runtime to server
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -avzr --delete --exclude=node_modules --exclude=dist --exclude=.git --exclude=.github
          path: core/orchestrator/modules/advertising/interface/
          remote_path: /srv/ai-src/ai-orchestrator/core/orchestrator/modules/advertising/interface/
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_port: ${{ secrets.DEPLOY_PORT }}
          remote_key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Restart API via PM2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -euo pipefail

            APP_DIR="/srv/ai-src/ai-orchestrator/core/orchestrator/modules/advertising/interface"
            cd "$APP_DIR"

            npm ci

            sudo /usr/bin/env \
              PGHOST="${{ secrets.PGHOST }}" \
              PGPORT="${{ secrets.PGPORT }}" \
              PGUSER="${{ secrets.PGUSER }}" \
              PGPASSWORD="${{ secrets.PGPASSWORD }}" \
              PGDATABASE="${{ secrets.PGDATABASE }}" \
              SPACE_API_PORT="${{ secrets.AIR_PORT }}" \
              /usr/local/bin/pm2 startOrReload ecosystem.config.cjs --update-env

            sudo /usr/local/bin/pm2 save --force

            curl -fsS "http://127.0.0.1:${{ secrets.AIR_PORT }}${{ secrets.API_BASE }}/space" >/dev/null
            echo "OK: space"

      - name: Reload Apache
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            sudo /bin/systemctl reload apache2
