name: Deploy public site

on:
  workflow_dispatch:
  push:
    branches: ["work", "main"]
    paths:
      - "site/**"
      - "scripts/publish_to_server.sh"
      - ".github/workflows/deploy-site.yml"
      - "DEPLOY.md"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          missing=0
          for key in SSH_HOST SSH_USER SSH_PRIVATE_KEY; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required GitHub secret: $key"
              missing=1
            fi
          done
          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup SSH key
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${SSH_PORT:-22}" "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy site to server (Apache /var/www/html)
        env:
          CONFIRM_DEPLOY: YES
          SERVER_HOST: ${{ secrets.SSH_HOST }}
          SERVER_USER: ${{ secrets.SSH_USER }}
          SERVER_PORT: ${{ secrets.SSH_PORT }}
          WEB_ROOT: ${{ secrets.WEB_ROOT }}
        run: ./scripts/publish_to_server.sh

      - name: Verify site from internet (HTTP 200)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SERVER_NAME: ${{ secrets.SERVER_NAME }}
        run: |
          set -e
          TARGET_HOST="$SSH_HOST"
          if [ -n "$SERVER_NAME" ] && [ "$SERVER_NAME" != "prod" ] && [ "$SERVER_NAME" != "_" ] && [[ "$SERVER_NAME" == *.* ]]; then
            TARGET_HOST="$SERVER_NAME"
          fi
          TARGET="http://${TARGET_HOST}/"
          echo "Checking $TARGET"
          for i in 1 2 3 4 5; do
            code=$(curl -sS -o /tmp/site.html -w '%{http_code}' "$TARGET" || true)
            echo "Attempt $i -> HTTP $code"
            if [ "$code" = "200" ]; then
              echo "External health check passed"
              exit 0
            fi
            sleep 3
          done
          echo "::error::External health check failed for $TARGET"
          exit 1

      - name: Deployment summary
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SERVER_NAME: ${{ secrets.SERVER_NAME }}
        run: |
          TARGET_HOST="$SSH_HOST"
          if [ -n "$SERVER_NAME" ] && [ "$SERVER_NAME" != "prod" ] && [ "$SERVER_NAME" != "_" ] && [[ "$SERVER_NAME" == *.* ]]; then
            TARGET_HOST="$SERVER_NAME"
          fi
          echo "Deployed successfully."
          echo "Open: http://${TARGET_HOST}/"
